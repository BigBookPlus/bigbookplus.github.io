<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>"开启face_recognition的CUDA支持以及人脸识别package的一点讨论"</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Docker GPU Docker Web Camera face_recogntion Face Recogntion insightface 开启face_recognition的CUDA支持的方法..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">BigBook's Tech Blog</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/kai-qi-face_recognitionde-cudazhi-chi-yi-ji-ren-lian-shi-bie-packagede-yi-dian-tao-lun.html" rel="bookmark"
           title="Permalink to "开启face_recognition的CUDA支持以及人脸识别package的一点讨论"">"开启face_recognition的CUDA支持以及人脸识别package的一点讨论"</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2023-03-31T00:00:00+02:00">
                Published: Fri 31 March 2023
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/bigbook.html">"BigBook"</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <ul>
<li>Docker</li>
<li>GPU Docker</li>
<li>Web Camera</li>
<li>face_recogntion</li>
<li>Face Recogntion</li>
<li>insightface</li>
</ul>
<hr>
<h2>开启face_recognition的CUDA支持的方法</h2>
<p>face_recognition是一个python包，用于人脸识别。属于基础的人脸识别包，支持人脸检测、人脸编码、人脸比对等功能。
face_recognition包支持使用GPU进行加速，但是默认情况下是不开启的。
也就是说，直接用Pip或这conda方式进行安装，装上的包基本上是不支持GPU计算的。
face_recognition的核心计算部分依赖dlib，所以需要安装dlib的GPU版本。如需要使用GPU进行加速的时候，需要安装CUDA和cuDNN。安装dlib的GPU版本，需要下载代码，开启cuda和cudnn支持，然后编译安装。
下面介绍一下安装过程。</p>
<h3>核心：编译安装dlib with CUDA</h3>
<p>官方文档介绍开启cuda支持的dlib的安装过程如下：</p>
<h2>Installing dlib using <code>conda</code> with CUDA enabled</h2>
<p>Prerequisite: <code>conda</code> and/or <code>miniconda</code> are already installed</p>
<ol>
<li>Create a conda environment.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>dlib<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8<span class="w"> </span>cmake<span class="w"> </span>ipython
</code></pre></div>

<ol>
<li>Activate the environment.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>conda<span class="w"> </span>activate<span class="w"> </span>dlib
</code></pre></div>

<ol>
<li>Install CUDA and cuDNN with <code>conda</code> using nvidia channel</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>conda<span class="w"> </span>install<span class="w"> </span>cuda<span class="w"> </span>cudnn<span class="w"> </span>-c<span class="w"> </span>nvidia
</code></pre></div>

<p>Then find the path to the <code>nvcc</code> of this environment. We will use this path for the build step below</p>
<div class="highlight"><pre><span></span><code><span class="gp">$</span>which<span class="w"> </span>nvcc
<span class="go">/path/to/your/miniconda3/envs/dlib/bin/</span>
</code></pre></div>

<ol>
<li>Install dlib.
Clone and build dlib from source</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/davisking/dlib.git
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>dlib
<span class="gp">$ </span>mkdir<span class="w"> </span>build
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>build
<span class="gp">$ </span>cmake<span class="w"> </span>..<span class="w"> </span>-DDLIB_USE_CUDA<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DUSE_AVX_INSTRUCTIONS<span class="o">=</span><span class="m">1</span><span class="w"> </span>-DCUDAToolkit_ROOT<span class="o">=</span>/path/to/your/miniconda3/envs/dlib/bin/
<span class="gp">$ </span>cmake<span class="w"> </span>--build<span class="w"> </span>.
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>..
<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>install<span class="w"> </span>--set<span class="w"> </span><span class="nv">DLIB_USE_CUDA</span><span class="o">=</span><span class="m">1</span>
</code></pre></div>

<ol>
<li>Test dlib</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="gp gp-VirtualEnv">(dlib)</span> <span class="gp">$ </span>ipython
<span class="go">Python 3.8.12 (default, Oct 12 2021, 13:49:34)</span>
<span class="go">Type &#39;copyright&#39;, &#39;credits&#39; or &#39;license&#39; for more information</span>
<span class="go">IPython 7.27.0 -- An enhanced Interactive Python. Type &#39;?&#39; for help.</span>

<span class="go">In [1]: import dlib</span>

<span class="go">In [2]: dlib.DLIB_USE_CUDA</span>
<span class="go">Out[2]: True</span>

<span class="go">In [3]: print(dlib.cuda.get_num_devices())</span>
<span class="go">1</span>
</code></pre></div>

<p>这样测试dlib如果成功支持了cuda，那么face_recognition也就支持了cuda。我在docker内做了测试，我的系统配置是
- ubuntu 20.04
- cuda 11.3
- cudnn 8.2.1
- python 3.8</p>
<h2>一点讨论</h2>
<h3>简洁性</h3>
<p>如果纯粹为了调包实现人脸识别，face_recognition是最佳选择。因为它的封装和逻辑足够简单。这里看一下官方文档的例子：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">face_recognition</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="s2">&quot;your_file.jpg&quot;</span><span class="p">)</span>
<span class="n">face_locations</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">face_locations</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</code></pre></div>

<p>仅需要这样几行代码，就可以实现人脸检测。如果需要更多的功能，比如人脸比对，人脸编码等，也是非常简单的。</p>
<p>如果做人脸识别，识别拜登和陌生人，那么可以这样做：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">face_recognition</span>
<span class="n">known_image</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="s2">&quot;biden.jpg&quot;</span><span class="p">)</span>
<span class="n">unknown_image</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="s2">&quot;unknown.jpg&quot;</span><span class="p">)</span>

<span class="n">biden_encoding</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span><span class="n">known_image</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">unknown_encoding</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span><span class="n">unknown_image</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">compare_faces</span><span class="p">([</span><span class="n">biden_encoding</span><span class="p">],</span> <span class="n">unknown_encoding</span><span class="p">)</span>
</code></pre></div>

<p>或者另外一个例子，识别我自己和陌生人：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">face_recognition</span>

<span class="n">picture_of_me</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="s2">&quot;me.jpg&quot;</span><span class="p">)</span>
<span class="n">my_face_encoding</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span><span class="n">picture_of_me</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># my_face_encoding now contains a universal &#39;encoding&#39; of my facial features that can be compared to any other picture of a face!</span>

<span class="n">unknown_picture</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="s2">&quot;unknown.jpg&quot;</span><span class="p">)</span>
<span class="n">unknown_face_encoding</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span><span class="n">unknown_picture</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Now we can see the two face encodings are of the same person with `compare_faces`!</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">face_recognition</span><span class="o">.</span><span class="n">compare_faces</span><span class="p">([</span><span class="n">my_face_encoding</span><span class="p">],</span> <span class="n">unknown_face_encoding</span><span class="p">)</span>

<span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s a picture of me!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It&#39;s not a picture of me!&quot;</span><span class="p">)</span>
</code></pre></div>

<p>文档推荐了一个例子<a href="https://github.com/ageitgey/face_recognition/blob/master/examples/recognize_faces_in_pictures.py">example</a>，可以参考。</p>
<h3>准确性</h3>
<p>在pypi的<a href="https://pypi.org/project/face-recognition/">文档</a>中，明确写了face_recognition是全世界最简单的人脸识别库(<code>the world’s simplest face recognition library</code>)，但是人脸识别依赖dlib，model准确率在lfw是99.38%。这个准确率只能说是马马虎虎，不是很高。如果需要更高的准确率，可以考虑使用其他的人脸识别库，比如<a href="https://pypi.org/project/insightface/">insightface</a>。看一下目前insightface 提供的人脸识别模型，在lfw上都在99.7%以上。</p>
<h2>总结</h2>
<p>face_recognition是一个非常简单的人脸识别库，但是准确率不高，并且默认安装并不支持CUDA计算，完全采用cpu计算。当一帧图像中人脸数目增加，计算负载是与人脸数目线性相关，对应其每帧消耗的人脸特征提取时间线性增加。如果完全依赖cpu，会引起操作系统卡顿。这样的负载，会让cpu不堪重负，尤其对于实时性要求高的程序来说。把计算负载转移到GPU是一个不错的方案，即令face_re cognition支持cuda计算。由于face_recognition核心计算部分依赖dlib，所以重新编译安装dlib，使其支持cuda计算，就可以实现face_recognition支持cuda计算。
如果需要更高的准确率，可以考虑使用其他的人脸识别库，比如<a href="https://pypi.org/project/insightface/">insightface</a>。</p>
<p>推荐使用linux测试新的技术和方案，如果担心对自己的环境有损坏，可以像我一样，使用docker。Docker可以支持GPU，甚至可以访问您的网络相机和usb相机，进行实时图像处理功能测试。使用docker唯一一个无法避免的问题可能是，它需要更多的磁盘空间。</p>
<p>参考(References)：</p>
<p><a href="https://gist.github.com/nguyenhoan1988/ed92d58054b985a1b45a521fcf8fa781">Installing dlib using conda with CUDA enabled</a></p>
<p><a href="https://wsthub.medium.com/python-real-time-facial-recognition-identification-with-cuda-enabled-4819844ffc80">python-real-time-facial-recognition-identification-with-cuda-enabled</a></p>
<p><a href="https://pypi.org/project/face-recognition/">pypi/face-recognition</a></p>
<p><a href="https://pypi.org/project/insightface/">insightface</a></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>