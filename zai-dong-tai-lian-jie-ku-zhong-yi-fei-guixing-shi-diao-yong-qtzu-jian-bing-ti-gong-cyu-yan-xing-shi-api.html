<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>"在动态链接库中以非GUI形式调用Qt组件并提供C语言形式API"</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="C/C++ Qt QtHttpServer CMake System Design 编译 QtHttpServer 模块 首先拉去代码 git clone https://github.com/qt-labs/qthttpserver.git cd qthttpserver git..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">BigBook's Tech Blog</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/zai-dong-tai-lian-jie-ku-zhong-yi-fei-guixing-shi-diao-yong-qtzu-jian-bing-ti-gong-cyu-yan-xing-shi-api.html" rel="bookmark"
           title="Permalink to "在动态链接库中以非GUI形式调用Qt组件并提供C语言形式API"">"在动态链接库中以非GUI形式调用Qt组件并提供C语言形式API"</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-08-18T00:00:00+02:00">
                Published: Wed 18 August 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/bigbook.html">"BigBook"</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <ul>
<li>C/C++</li>
<li>Qt</li>
<li>QtHttpServer</li>
<li>CMake</li>
<li>System Design</li>
</ul>
<hr>
<h3>编译 QtHttpServer 模块</h3>
<p>首先拉去代码</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/qt-labs/qthttpserver.git
<span class="nb">cd</span><span class="w"> </span>qthttpserver
git<span class="w"> </span>checkout<span class="w"> </span><span class="m">5</span>.15
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
</code></pre></div>

<p>然后用qtcreator打开工程，编译</p>
<h3>最简单的Qt代码</h3>
<p>如果想构建一个最简单的Qt程序，那么大概就是一个没有UI、控制台下运行的HelloWorld程序，它的代码大概是这个样子：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtCore&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">QCoreApplication</span><span class="w"> </span><span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// qDebug()&lt;&lt;&quot;Hello World&quot;;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3>使用QtHttpServer</h3>
<p>QtHttpServer目前不在Qt的主lib中，据说Qt6会正式加入。所以需要自行下载编译。<a href="https://github.com/qt-labs/qthttpserver"></a></p>
<h4>编译QtHttpServer</h4>
<p>我使用的是Qt5，牵出5.15分支，并自己使用QtCreator编译：</p>
<div class="highlight"><pre><span></span><code><span class="go">git clone https://github.com/qt-labs/qthttpserver.git</span>
<span class="go">git checkout 5.15</span>
</code></pre></div>

<p>编译成功后，将头文件和动态库拷贝到所使用的Qt安装路径下的对应目录内即可。</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>build-qthttpserver-Desktop_Qt_5_12_6_GCC_64bit-Release/
mv<span class="w"> </span>./*<span class="w"> </span>/opt/Qt5.12.6/5.12.6/gcc_64/lib/

<span class="nb">cd</span><span class="w"> </span>cmake/
mv<span class="w"> </span>./*<span class="w"> </span>/opt/Qt5.12.6/5.12.6/gcc_64/lib/cmake/

<span class="nb">cd</span><span class="w"> </span>..
<span class="nb">cd</span><span class="w"> </span>pkgconfig/
mv<span class="w"> </span>./*<span class="w"> </span>/opt/Qt5.12.6/5.12.6/gcc_64/lib/pkgconfig/

<span class="nb">cd</span><span class="w"> </span>..
<span class="nb">cd</span><span class="w"> </span>..
<span class="nb">cd</span><span class="w"> </span>include/
mv<span class="w"> </span>./*<span class="w"> </span>/opt/Qt5.12.6/5.12.6/gcc_64/include/

<span class="nb">cd</span><span class="w"> </span>..
<span class="nb">cd</span><span class="w"> </span>mkspecs
<span class="nb">cd</span><span class="w"> </span>modules
mv<span class="w"> </span>./*<span class="w"> </span>/opt/Qt5.12.6/5.12.6/gcc_64/mkspecs/modules/
</code></pre></div>

<h4>启动QtHttpServer</h4>
<p>在Qt官方blog <a href="https://www.qt.io/blog/2019/01/25/introducing-qt-http-server">introducing-qt-http-server</a>，介绍了一个最基本的QHttpServer用法：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtCore&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtHttpServer&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">QCoreApplication</span><span class="w"> </span><span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">QHttpServer</span><span class="w"> </span><span class="n">httpServer</span><span class="p">;</span>
<span class="w">  </span><span class="n">httpServer</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Hello world&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="n">httpServer</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="n">QHostAddress</span><span class="o">::</span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="mi">9527</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>程序启动后，浏览器打开 <a href="http://127.0.0.1:9527"></a> 就可以看到HelloWorld了，所以这里Server提供了Get方法。那么如果想提供POST方法并接受一段数据呢？</p>
<p>加入如下代码即可:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">httpserver</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/post-body&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;POST&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">QHttpServerRequest</span><span class="w"> </span><span class="o">&amp;</span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
</code></pre></div>

<p>body中可以传入json等并进行解析。其他用法，推荐一篇详细介绍QtHttpServer接口routing方法的blog <a href="https://www.qt.io/blog/2019/02/01/qhttpserver-routing-api">qhttpserver-routing-api</a>。</p>
<h3>封装主服务类</h3>
<p>在MainSVC中，对HttpServer进行管理。实际使用时MainSVC还可以封装了其他功能，作为整体服务的入口。</p>
<h4>MainSVC头文件</h4>
<div class="highlight"><pre><span></span><code><span class="c1">// FileName: mainsvc.h</span>
<span class="c1">// Author: BigBookPlus</span>
<span class="c1">// Reference: http://bigbookplus.github.io</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MainSVC</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">QObject</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Q_OBJECT</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">MainSVC</span><span class="p">(</span><span class="n">QObject</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="o">=</span><span class="k">nullptr</span><span class="p">);</span>
<span class="w">    </span><span class="o">~</span><span class="n">MainSVC</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>

<h4>实现文件，加入QtHttpServer功能</h4>
<p>MainSVC类的实现文件。这里要保证QtHttpServer是全局变量，否则Server无法正常运行。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// FileName: mainsvc.cpp</span>
<span class="c1">// Author: BigBookPlus</span>
<span class="c1">// Reference: http://bigbookplus.github.io</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QHttpServer&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mainsvc.h&quot;</span>

<span class="p">...</span>

<span class="k">static</span><span class="w"> </span><span class="n">QtHttpServer</span><span class="w"> </span><span class="n">http_server</span><span class="p">;</span>

<span class="n">MainSVC</span><span class="o">::</span><span class="n">MainSVC</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">http_server</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;BigBookPlus Server Test.&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="n">MainSVC</span><span class="o">::~</span><span class="n">MainSVC</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">MainSVC</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9527</span><span class="p">;</span>
<span class="w">    </span><span class="n">http_server</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="n">QHostAddress</span><span class="o">::</span><span class="n">Any</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">...</span>
</code></pre></div>

<h3>在动态链接库中使用Qt组件并提供C语言形式API</h3>
<h4>关于QApplication/QCoreApplication</h4>
<p>如果在动态库中直接调用了qt的组件实现功能，而调用它的C++工程不是Qt工程，大概率会出现一条和QApplication/QCoreApplication有关的报错信息，大概意思就是某些模块必须要QApplication/QCoreApplication才能运行。</p>
<p>具体来说，Non-GUI的QCore组件只需要依赖QCoreApplication对象；而涉及到GUI的例如QWidget组件则依赖QApplication对象。QApplication类其实继承自QCoreApplication。Qt主程序执行了它们的exec()方法，该Qt程序的EventLoop和EventDispatcher等功能才能正确运行，这样进而保证了信号和槽等机制的正常运转。实际使用时，应当令QApplication/QCoreApplication的对象变量位于主线程空间，而事件循环可以在其他线程执行，即exec()方法可以在子线程运行。因为exec()是个阻塞的方法，所以放在其他线程执行不会影响主线程，方便很多。</p>
<p>显而易见，不是所有的组件都需要必须有个QApplication/QCoreApplication，进一步说，即使需要QApplication/QCoreApplication对象，其实也可以只定义一个全局变量，而不需要真的执行它的exec方法。</p>
<p>在我的业务场景中，要给UI端以动态链接库的形式提供功能，除了一些一般的实时处理功能，还要在动态库的生命周期开启一个HttpServer，而不巧的是，QtHttpServer需要QCoreApplication对象。谨慎起见，同时我也决定在子线程中执行exec运行事件循环。最后，用户需要提供的是C接口，所以我将主服务接口以MainSVC对象进行封装完毕后，又定义了一套C形式的API。</p>
<h4>QCoreApplication全局对象</h4>
<p>首先在动态链接库的入口实现文件里，定义QCoreApplication全局对象，为了让对象正确初始化，我在这里定义了假的argc/argv参数变量：</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="kt">char</span><span class="w"> </span><span class="n">param</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="n">QCoreApplication</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</code></pre></div>

<h4>服务初始化</h4>
<p>然后定义一个init函数，函数内new了一个我封装的主服务类的对象，并开启了事件循环。</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">main_svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MainSVC</span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>这个函数将在动态链接库的导出的初始化函数svc_init中，开启一个子线程来执行。使用时，用户调用svc_init，即可完成服务的初始化。下面是svc_init的定义：</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">svc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">QFuture</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QtConcurrent</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4>实现文件</h4>
<p>但是有个新问题，用户直接调用svc_init进行测试，由于后面没有其他操作很快就退出了，因为初始化都是在线程中异步执行的。不能让用户在主线程中等待，简单的方法是在全局变量中增加一个QMutex对象进行控制，再再init和svc_init中访问此变量，即可简单达到同步的功能。初始化该动态库，会提供一个HttpServer供所有人调用。该动态库提供的服务在初始化阶段保证初始化完成后退出，提供给用户调用svc_start方法，启动服务，用户如需要服务一直运行，则后续自行控制主线程生命周期即可。完整实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// FileName: svc_c_api.cpp</span>
<span class="c1">// Author: BigBookPlus</span>
<span class="c1">// Reference: http://bigbookplus.github.io</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtCore&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtCore/QVariant&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;QtConcurrent&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;svc_c_api.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mainsvc.h&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="kt">char</span><span class="w"> </span><span class="n">param</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">;</span><span class="w">    </span><span class="c1">// magic string. nonsense.</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">QCoreApplication</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="k">static</span><span class="w"> </span><span class="n">QMutex</span><span class="w"> </span><span class="n">init_lock</span><span class="p">;</span>

<span class="n">MainSVC</span><span class="o">*</span><span class="w"> </span><span class="n">main_svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">init_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_svc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MainSVC</span><span class="p">(</span><span class="n">Q_NULLPTR</span><span class="p">);</span>
<span class="w">  </span><span class="n">init_lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">svc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">QFuture</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QtConcurrent</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>

<span class="w">  </span><span class="n">QThread</span><span class="o">::</span><span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"> </span><span class="c1">// ensure init_lock mutex has been locked.</span>
<span class="w">  </span><span class="n">init_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w">     </span><span class="c1">// ensure main_svc initilizition finished.</span>
<span class="w">  </span><span class="n">init_lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span><span class="w">   </span><span class="c1">// unlock</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">svc_start</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">main_svc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">main_svc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4>接口文件</h4>
<p>C语言形式的API的头文件实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// FileName: svc_c_api.h</span>
<span class="c1">// Author: BigBookPlus</span>
<span class="c1">// Reference: http://bigbookplus.github.io</span>

<span class="cp">#ifndef SVC_C_API_H_</span>
<span class="cp">#define SVC_C_API_H_</span>

<span class="cp">#if defined(_MSC_VER)</span>
<span class="cp"># if defined(SVC_LIB)</span>
<span class="cp">#  define SVC_QTLIB_EXPORT __declspec(dllexport)</span>
<span class="cp"># else</span>
<span class="cp">#  define SVC_QTLIB_EXPORT __declspec(dllimport)</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define SVC_QTLIB_EXPORT</span>
<span class="cp">#endif</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdbool.h&gt;</span>

<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#endif</span>
<span class="w">  </span><span class="n">SVC_QTLIB_EXPORT</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">svc_init</span><span class="p">();</span><span class="w"> </span><span class="c1">//before init</span>
<span class="w">    </span><span class="n">SVC_QTLIB_EXPORT</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">svc_start</span><span class="p">();</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>
</code></pre></div>

<h3>后记：怎样构建（编译）</h3>
<p>构建Qt项目的方法有很多，可以是Visual Studio + Qt插件，也可以用QtCreator。不过我更喜欢CMake的方式进行构建。基本的方法可以参考Qt官方关于CMake的指南<a href="https://doc.qt.io/qt-5/cmake-get-started.html">cmake-get-started</a>。Qt项目编译中的关键步骤:MOC、UIC、RCC都可以通过添加一行指令，让CMake自动完成。用CMake管理Qt项目，基本和普通的C++项目感觉不到太大区别。</p>
<p>这里提供一个我写的示例：</p>
<div class="highlight"><pre><span></span><code><span class="n">cmake_minimum_required</span><span class="p">(</span><span class="n">VERSION</span><span class="w"> </span><span class="mf">3.8.0</span><span class="p">)</span>

<span class="n">project</span><span class="p">(</span><span class="n">test</span><span class="o">-</span><span class="n">svc</span><span class="w"> </span><span class="n">VERSION</span><span class="w"> </span><span class="mf">0.1.0</span><span class="w"> </span><span class="n">LANGUAGES</span><span class="w"> </span><span class="n">CXX</span><span class="p">)</span>

<span class="n">set</span><span class="p">(</span><span class="n">Qt5_DIR</span><span class="w"> </span><span class="n">D</span><span class="o">:/</span><span class="n">Qt</span><span class="o">/</span><span class="n">Qt5</span><span class="mf">.12.6</span><span class="o">/</span><span class="mf">5.12.6</span><span class="o">/</span><span class="n">msvc2017_64</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">cmake</span><span class="o">/</span><span class="n">Qt5</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">replace</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">own</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Qt</span><span class="p">.</span>

<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span>
<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_CXX_STANDARD_REQUIRED</span><span class="w"> </span><span class="n">ON</span><span class="p">)</span>

<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_AUTOMOC</span><span class="w"> </span><span class="n">ON</span><span class="p">)</span>
<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_AUTORCC</span><span class="w"> </span><span class="n">ON</span><span class="p">)</span>
<span class="n">set</span><span class="p">(</span><span class="n">CMAKE_AUTOUIC</span><span class="w"> </span><span class="n">ON</span><span class="p">)</span>

<span class="n">add_definitions</span><span class="p">(</span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">SVC_LIB</span><span class="p">)</span>

<span class="n">find_package</span><span class="p">(</span><span class="n">Qt5</span><span class="w"> </span><span class="n">COMPONENTS</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Concurrent</span><span class="w"> </span><span class="n">HttpServer</span><span class="w"> </span><span class="n">REQUIRED</span><span class="p">)</span>

<span class="n">set</span><span class="p">(</span><span class="n">USED_QT_LIBRARYS</span><span class="w"> </span><span class="n">Qt5</span><span class="o">::</span><span class="n">Core</span><span class="w"> </span><span class="n">Qt5</span><span class="o">::</span><span class="n">Network</span><span class="w">  </span><span class="n">Qt5</span><span class="o">::</span><span class="n">Concurrent</span><span class="w">  </span><span class="n">Qt5</span><span class="o">::</span><span class="n">HttpServer</span><span class="p">)</span>

<span class="n">aux_source_directory</span><span class="p">(</span><span class="n">src</span><span class="w"> </span><span class="n">SVC_SRCS</span><span class="p">)</span>

<span class="n">add_library</span><span class="p">(</span><span class="n">snn</span><span class="o">-</span><span class="n">svc</span><span class="w"> </span><span class="n">SHARED</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">SVC_SRCS</span><span class="p">}</span><span class="w"> </span><span class="p">)</span>
<span class="n">target_link_libraries</span><span class="p">(</span><span class="n">snn</span><span class="o">-</span><span class="n">svc</span><span class="w">  </span><span class="n">$</span><span class="p">{</span><span class="n">USED_QT_LIBRARYS</span><span class="p">})</span>
</code></pre></div>

<h3>END</h3>
<p>欢迎留言探讨。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>