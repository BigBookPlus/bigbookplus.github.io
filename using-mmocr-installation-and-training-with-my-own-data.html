<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>"Using MMOCR: Installation and Training with my own Data"</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="MMOCR OCR Pytorch What is OCR? According to the wikipedia, OCR, which refers to Optical character recognition or optical character reader, is the..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">BigBook's Tech Blog</a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/misc.html">misc</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/using-mmocr-installation-and-training-with-my-own-data.html" rel="bookmark"
           title="Permalink to "Using MMOCR: Installation and Training with my own Data"">"Using MMOCR: Installation and Training with my own Data"</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2022-03-04T00:00:00+01:00">
                Published: Fri 04 March 2022
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/bigbook.html">"BigBook"</a>
        </address>
<p>In <a href="/category/misc.html">misc</a>.</p>

</footer><!-- /.post-info -->      <ul>
<li>MMOCR</li>
<li>OCR</li>
<li>Pytorch</li>
</ul>
<hr>
<h2>What is OCR?</h2>
<p>According to the wikipedia, OCR, which refers to <strong>Optical character recognition</strong> or <strong>optical character reader,</strong> is the electronic  or mechanical  conversion of images  of typed, handwritten or printed text into machine-encoded text.</p>
<h2>Why MMOCR?</h2>
<ul>
<li>Pytorch</li>
<li>Maintained by Openmmlab</li>
<li>Easy to train your own data</li>
<li>Can be deployed into C++ code</li>
</ul>
<p>Pytorch is sweet, it seems to have absorbed most of the advantages of current deep learning frameworks. It is maintained by the OpenMMLab, belongs to SenseTime, which means that this repo can live long and keep updating. MMOCR has a clear structure just like MMDetection. It has the experimental deployment code too.</p>
<h2>Installation</h2>
<p>The installation guide in  <a href="[https://mmocr.readthedocs.io/en/latest/install.html](https://mmocr.readthedocs.io/en/latest/install.html)">mmocr doc</a> is quite in great detail. I will show the setup process on my machine.</p>
<div class="highlight"><pre><span></span><code>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>open-mmlab<span class="w"> </span><span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8
conda<span class="w"> </span>activate<span class="w"> </span>open-mmlab
</code></pre></div>

<p>Now we have an isolated virtual environment. Then I install PyTorch 1.10 with CUDA 10.2.</p>
<div class="highlight"><pre><span></span><code>conda<span class="w"> </span>install<span class="w"> </span><span class="nv">pytorch</span><span class="o">=</span><span class="m">1</span>.10.0<span class="w"> </span>torchvision<span class="w"> </span><span class="nv">cudatoolkit</span><span class="o">=</span><span class="m">10</span>.2<span class="w"> </span>-c<span class="w"> </span>pytorch
</code></pre></div>

<p>Then install mmcv, mmdet.</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>mmcv-full<span class="w"> </span>-f<span class="w"> </span>https://download.openmmlab.com/mmcv/dist/cu102/torch1.10.0/index.html
pip<span class="w"> </span>install<span class="w"> </span>mmdet
</code></pre></div>

<p>Clone MMOCR repo</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/open-mmlab/mmocr.git
<span class="nb">cd</span><span class="w"> </span>mmocr
</code></pre></div>

<p>Final step, build and install.</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
pip<span class="w"> </span>install<span class="w"> </span>-v<span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span><span class="c1"># or &quot;python setup.py develop&quot;</span>
</code></pre></div>

<p>There is an extra step in the mmocr doc website, which export the repo path into system env var  PYTHONPATH. In my case, I always works inside the repo path, so I didn’t go with this step. If you need to import mmocr from other projects, you may need to do it.</p>
<h2>Simple test</h2>
<p>We can run a simple command to test our repo, this command will automatically downloads the weights file and do detection &amp; recognition end-to-end.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>mmocr/utils/ocr.py<span class="w"> </span>demo/demo_text_ocr.jpg<span class="w"> </span>--print-result<span class="w"> </span>--imshow
</code></pre></div>

<p>Also, we can run text detection only. By specifying ‘det’ option, we test with the TextSnake algorithm.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>mmocr/utils/ocr.py<span class="w"> </span>demo/demo_text_det.jpg<span class="w"> </span>--output<span class="w"> </span>demo/det_out.jpg<span class="w"> </span>--det<span class="w"> </span>TextSnake<span class="w"> </span>--recog<span class="w"> </span>None<span class="w"> </span>--export<span class="w"> </span>demo/
</code></pre></div>

<h2>Training with my own data</h2>
<p>I’m trying to train our own text detection model.  Download the prepared data file and train following the doc page is obviously not enough for me. My training data is labeled in PASCAL_VOC format, which means we need more work to do. Create a folder in repo named data, then put dataset folder in it or create a link by command ln -s into it.</p>
<p>We first create a python scripts named gen_ids.py to generate the training and testing file ids.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;generate id list file.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span> <span class="s1">&#39;path to annotation files dir.&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;--output&#39;, type=str, default=&#39;./ids.txt&#39;, help= &#39;path to output.&#39;)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">generate_ids</span><span class="p">(</span><span class="n">anno_path</span> <span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./train_ids.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ftrain</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./test_ids.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ftest</span><span class="p">:</span>
        <span class="n">cntr</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">anno_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cntr</span> <span class="o">%</span><span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ftest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ftrain</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">cntr</span><span class="o">+=</span><span class="mi">1</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">generate_ids</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>Suppose we are working in dataset path, say, data/dataset/, Pascal_voc format puts its annotations in the Annotation folder. We run this script.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>gen_ids.py<span class="w"> </span>--path<span class="w"> </span>./Annotations/
</code></pre></div>

<p>Thus I have the train_ids.txt and test_ids.txt in my dataset folder. </p>
<p>We adopt from ICDAR format to train. ICDAR Dataset follows coco format, so we need to convert our pascal_voc format to coco format. We need to create another python script named voc2coco.py to do it. (Which is modified from others)</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">get_label2id</span><span class="p">(</span><span class="n">labels_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;id is 1 start&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">labels_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">labels_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels_str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels_str</span><span class="p">,</span> <span class="n">labels_ids</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_annpaths</span><span class="p">(</span><span class="n">ann_dir_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ann_ids_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">annpaths_list_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># If use annotation paths list</span>
    <span class="k">if</span> <span class="n">annpaths_list_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annpaths_list_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ann_paths</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ann_paths</span>

    <span class="c1"># If use annotaion ids list</span>
    <span class="n">ext_with_dot</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span> <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ann_ids_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ann_ids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ann_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_dir_path</span><span class="p">,</span> <span class="n">aid</span><span class="o">+</span><span class="n">ext_with_dot</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid</span> <span class="ow">in</span> <span class="n">ann_ids</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ann_paths</span>

<span class="k">def</span> <span class="nf">get_image_info</span><span class="p">(</span><span class="n">annotation_root</span><span class="p">,</span> <span class="n">extract_num_from_imgid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">annotation_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">annotation_root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">img_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">img_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">extract_num_from_imgid</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">img_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">img_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">annotation_root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>

    <span class="n">image_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;file_name&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">img_id</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">image_info</span>

<span class="k">def</span> <span class="nf">get_coco_annotation_from_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">label2id</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label2id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> is not in label2id !&quot;</span>
    <span class="n">category_id</span> <span class="o">=</span> <span class="n">label2id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
    <span class="n">bndbox</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">)))</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bndbox</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="n">xmin</span> <span class="ow">and</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="n">ymin</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Box size error !: (xmin, ymin, xmax, ymax): </span><span class="si">{</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">ymin</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">o_width</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span>
    <span class="n">o_height</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
    <span class="n">ann</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="n">o_width</span> <span class="o">*</span> <span class="n">o_height</span><span class="p">,</span>
        <span class="s1">&#39;iscrowd&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">o_width</span><span class="p">,</span> <span class="n">o_height</span><span class="p">],</span>
        <span class="s1">&#39;category_id&#39;</span><span class="p">:</span> <span class="n">category_id</span><span class="p">,</span>
        <span class="s1">&#39;ignore&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;segmentation&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span> <span class="p">]</span>  <span class="c1"># This script is not for segmentation</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ann</span>

<span class="k">def</span> <span class="nf">convert_xmls_to_cocojson</span><span class="p">(</span><span class="n">annotation_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">label2id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                             <span class="n">output_jsonpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">extract_num_from_imgid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">output_json_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;images&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;instances&quot;</span><span class="p">,</span>
        <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    <span class="n">bnd_id</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># START_BOUNDING_BOX_ID, TODO input as args ?</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start converting !&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">annotation_paths</span><span class="p">):</span>
        <span class="c1"># Read annotation xml</span>
        <span class="n">ann_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">a_path</span><span class="p">)</span>
        <span class="n">ann_root</span> <span class="o">=</span> <span class="n">ann_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">img_info</span> <span class="o">=</span> <span class="n">get_image_info</span><span class="p">(</span><span class="n">annotation_root</span><span class="o">=</span><span class="n">ann_root</span><span class="p">,</span>
                                  <span class="n">extract_num_from_imgid</span><span class="o">=</span><span class="n">extract_num_from_imgid</span><span class="p">)</span>
        <span class="n">img_id</span> <span class="o">=</span> <span class="n">img_info</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="c1">#print(img_id+&#39; &#39;)</span>
        <span class="n">output_json_dict</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_info</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">ann_root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span>
            <span class="n">ann</span> <span class="o">=</span> <span class="n">get_coco_annotation_from_obj</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">)</span>
            <span class="n">ann</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">img_id</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">bnd_id</span><span class="p">})</span>
            <span class="n">output_json_dict</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ann</span><span class="p">)</span>
            <span class="n">bnd_id</span> <span class="o">=</span> <span class="n">bnd_id</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">label_id</span> <span class="ow">in</span> <span class="n">label2id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">category_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;supercategory&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">label_id</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">}</span>
        <span class="n">output_json_dict</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">category_info</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_jsonpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">output_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output_json_dict</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_json</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This script support converting voc format xmls to coco format json&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ann_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to annotation files directory. It is not need when use --ann_paths_list&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ann_ids&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to annotation files ids list. It is not need when use --ann_paths_list&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ann_paths_list&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path of annotation paths list. It is not need when use --ann_dir and --ann_ids&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--labels&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to label list.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;output.json&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to output json file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ext&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;additional extension of annotation file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--extract_num_from_imgid&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Extract image number from the image filename&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">label2id</span> <span class="o">=</span> <span class="n">get_label2id</span><span class="p">(</span><span class="n">labels_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ann_paths</span> <span class="o">=</span> <span class="n">get_annpaths</span><span class="p">(</span>
        <span class="n">ann_dir_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ann_dir</span><span class="p">,</span>
        <span class="n">ann_ids_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ann_ids</span><span class="p">,</span>
        <span class="n">ext</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
        <span class="n">annpaths_list_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ann_paths_list</span>
    <span class="p">)</span>
    <span class="n">convert_xmls_to_cocojson</span><span class="p">(</span>
        <span class="n">annotation_paths</span><span class="o">=</span><span class="n">ann_paths</span><span class="p">,</span>
        <span class="n">label2id</span><span class="o">=</span><span class="n">label2id</span><span class="p">,</span>
        <span class="n">output_jsonpath</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
        <span class="n">extract_num_from_imgid</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">extract_num_from_imgid</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>We need to create a file named coco.names txt file, which contains only one line in my case.  </p>
<div class="highlight"><pre><span></span><code>text
</code></pre></div>

<p>Then we can start converting. </p>
<div class="highlight"><pre><span></span><code><span class="n">python</span> <span class="n">voc2coco</span><span class="o">.</span><span class="n">py</span>  <span class="o">--</span><span class="n">ann_dir</span> <span class="o">./</span><span class="n">Annotations</span><span class="o">/</span> <span class="o">--</span><span class="n">ann_ids</span> <span class="o">./</span><span class="n">train_ids</span><span class="o">.</span><span class="n">txt</span> <span class="o">--</span><span class="n">labels</span> <span class="o">./</span><span class="n">coco</span><span class="o">.</span><span class="n">names</span>  <span class="o">--</span><span class="n">output</span> <span class="o">./</span><span class="n">annotations</span><span class="o">/</span><span class="n">instances_training</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">ext</span> <span class="n">xml</span>
<span class="n">python</span> <span class="n">voc2coco</span><span class="o">.</span><span class="n">py</span>  <span class="o">--</span><span class="n">ann_dir</span> <span class="o">./</span><span class="n">Annotations</span><span class="o">/</span> <span class="o">--</span><span class="n">ann_ids</span> <span class="o">./</span><span class="n">test_ids</span><span class="o">.</span><span class="n">txt</span> <span class="o">--</span><span class="n">labels</span> <span class="o">./</span><span class="n">coco</span><span class="o">.</span><span class="n">names</span>  <span class="o">--</span><span class="n">output</span> <span class="o">./</span><span class="n">annotations</span><span class="o">/</span><span class="n">instances_test</span><span class="o">.</span><span class="n">json</span> <span class="o">--</span><span class="n">ext</span> <span class="n">xml</span>
</code></pre></div>

<p>Now we have the coco format annotation file in dataset folder. We are ready to train.</p>
<p>Create a new script in configs/<em>base</em>/det_datasets/new_dataset.py which can be adopted from configs/<em>base</em>/det_datasets/icdar2015.py and change several path variables. Then create another script from configs/textdet/dbnet/dbnet_r50dcnv2_fpnc_1200e_icdar2015.py, named configs/textdet/dbnet/dbnet_r50dcnv2_fpnc_1200e_new_dataset.py, just change the line for dataset configuration.</p>
<div class="highlight"><pre><span></span><code>_base_ = [
        ...
    &#39;../../_base_/det_datasets/new_dataset.py&#39;, #&#39;../../_base_/det_datasets/icdar2015.py&#39;,
        ...
]
</code></pre></div>

<p>Then we are ready to start training with multiple gpus. MMOCR provided a handy shell script to train with multiple gpus, tools/dist_train.sh.</p>
<div class="highlight"><pre><span></span><code><span class="o">./</span><span class="n">tools</span><span class="o">/</span><span class="n">dist_train</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="n">configs</span><span class="o">/</span><span class="n">textdet</span><span class="o">/</span><span class="n">dbnet</span><span class="o">/</span><span class="n">dbnet_r50dcnv2_fpnc_1200e_new_dataset</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">work_dirs</span><span class="o">/</span><span class="n">dbnet_r50dcnv2_fpnc_1200e_new_dataset</span><span class="w"> </span><span class="mi">8</span>
</code></pre></div>

<p>Done. I use 8 gpus to train my model.</p>
<h2>P.S.</h2>
<p>I feel MMOCR is easy to configure and very stable. It record training logs automatically. The deployment code is ok to use, though is experimental. I have successfully transformed model to onnx and run with c++ code.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://getpelican.com/">Pelican</a></li>
                            <li><a href="https://www.python.org/">Python.org</a></li>
                            <li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>