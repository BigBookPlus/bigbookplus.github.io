import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as c,c as l,a as s,b as n,d as e,f as a}from"./app-d4e9035c.js";const i={},u=a(`<p>OpenCV has a DNN module, which is powerful, efficient, and easy to use. To implement a DNN inference application, we need only to call a couple of APIs which are offered by OpenCV DNN module. The basic routine of implementation a DNN inference code by OpenCV is as below.</p><blockquote><ul><li>Initialization. Creating the cv::dnn::Net object by reading in the network weight. (caffe/onnx...)</li><li>Preprocessing. Determine shape of input data of the network. Reshape the raw input image(s) to match the input data shape. This step always combined some other operatations such as normalization.</li><li>Inference. Call inference method by the created cv::dnn::Net object.</li><li>Postprocessing. Decoding the output data and do further wrangling.</li></ul></blockquote><p>In my opinion, as the network weights are already determined, the most important parts of the deployment are pre&amp;postprocessing. You need to figure out exactly what shape of input data is, and what the normalization method is (mean/std value). In post processing, things may be much more complicated. Some tasks are easy to implement, classification tasks for instance. Some tasks will be much harder to implement, such as object detection/segmentation tasks. You need to do a lot of work to crack the data wrangling problems, and sometimes may need to rewrite some operatations yourself from scratch, just because there is no corresponding method with the original python implementation in C++.</p><p>In this article, I will describe a simple implementation of image classification by OpenCV DNN module, and give a fast tour of batch inference.</p><h2 id="important-apis" tabindex="-1"><a class="header-anchor" href="#important-apis" aria-hidden="true">#</a> Important APIs</h2><p>To load the weights into device and create the DNN Net object, Opencv DNN module provided a readNet method. It supports ONNX/Caffe/TF/OpenVINO...</p><p>In this article, we use Caffe model as the example.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Net cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span>  <span class="token keyword">const</span> String <span class="token operator">&amp;</span> prototxt<span class="token punctuation">,</span> \\
                                <span class="token keyword">const</span> String <span class="token operator">&amp;</span> caffeModel <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>This API will read the network weights in Caffe format.</p><p>Parameters</p><ul><li><code>prototxt</code> path to the .prototxt file with text description of the network architecture.</li><li><code>caffeModel</code> path to the .caffemodel file with learned network.</li></ul><p>Returns<br> Net object.</p></blockquote><p>We also need to call <code>blobFromImage</code> to do some preprocessing on the input cv::Mat image.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Mat cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImage</span><span class="token punctuation">(</span> InputArray image<span class="token punctuation">,</span>
                            <span class="token keyword">double</span> scalefactor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Size <span class="token operator">&amp;</span> size <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Scalar <span class="token operator">&amp;</span> mean <span class="token operator">=</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> swapRB <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> crop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">int</span> ddepth <span class="token operator">=</span> CV_32F<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Creates 4-dimensional blob from image. Optionally resizes and crops image from center, subtract mean values, scales values by scalefactor, swap Blue and Red channels.</p><p>Parameters</p><ul><li><code>image</code> input image (with 1-, 3- or 4-channels).</li><li><code>size</code> spatial size for output image</li><li><code>mean</code> scalar with mean values which are subtracted from channels. Values are intended to be in (mean-R, mean-G, mean-B) order if image has BGR ordering and swapRB is true.</li><li><code>scalefactor</code> multiplier for image values.</li><li><code>swapRB</code> flag which indicates that swap first and last channels in 3-channel image is necessary.</li><li><code>crop</code> flag which indicates whether image will be cropped after resize or not</li><li><code>ddepth</code> Depth of output blob. Choose CV_32F or CV_8U.<br> if crop is true, input image is resized so one side after resize is equal to corresponding dimension in size and another one is equal or larger. Then, crop from the center is performed. If crop is false, direct resize without cropping and preserving aspect ratio is performed.</li></ul><p>Returns<br> 4-dimensional Mat with NCHW dimensions order.</p></blockquote><h2 id="difference-between-cv-mat-image-and-blob" tabindex="-1"><a class="header-anchor" href="#difference-between-cv-mat-image-and-blob" aria-hidden="true">#</a> Difference Between cv::Mat Image and Blob</h2><p>The mainly difference is the data format. In normal cv::Mat image, the data is arranged in HWC format, like <code>RGBRGB...RGB</code>. But when turned into blobs, it becomes NCHW format, as most neural networks does.</p><p>In normal cv::Mat image, we get width and height by member <code>cols</code> and <code>rows</code>, but in blob, these two vars is -1. We get blob size by <code>blob.size(0)</code> <code>blob.size(1)</code> etc. This is useful when we need to decompose the result mat from batch inference.</p><h2 id="include-stuffs-we-need" tabindex="-1"><a class="header-anchor" href="#include-stuffs-we-need" aria-hidden="true">#</a> Include stuffs we need</h2><p>We firstly include all the stuffs to use OpenCV DNN. Then we declare a Global cv::dnn:Net Variable. This var will load net weights from your disk and do nearly all the nn calculation tasks.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/dnn.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core/cuda.hpp&quot;</span></span>

<span class="token comment">// Global net variable.</span>
cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>Net net<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Suppose we have a caffe model, we pass the <code>.prototxt</code> file name to the var <code>model_deploy</code>, and <code>.caffemodel</code> file to var <code>model_bin</code>. We do the init works in this <code>init</code> function:</p>`,19),r={href:"http://bigbook.plus/2021/08/16/opencv-cmake-vs2019/",target:"_blank",rel:"noopener noreferrer"},d=a(`<div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> model_deploy<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> model_bin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    net <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span>model_deploy<span class="token punctuation">,</span> model_bin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Let CUDA be the calculation device.</span>
    cv<span class="token double-colon punctuation">::</span>cuda<span class="token double-colon punctuation">::</span><span class="token function">setDevice</span><span class="token punctuation">(</span>cuda_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>net<span class="token punctuation">.</span><span class="token function">setPreferableBackend</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>net<span class="token punctuation">.</span><span class="token function">setPreferableTarget</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>DNN_TARGET_CUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="single-image-inference" tabindex="-1"><a class="header-anchor" href="#single-image-inference" aria-hidden="true">#</a> Single Image Inference</h2><p>Now we try to do the single image inference.</p><p>It&#39;s simple. Call <code>blobFromImage</code> method to turn the image into a blob, then set this blob as the input to <code>net</code> by <code>net.setInput</code>, finally we got the output <code>cv::Mat</code> by <code>net.forward()</code>.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">single_inference</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> image<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;empty image!!!&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat blob <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \\
    cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">post_process</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>After we got the original output by neural network, we need to do the post-processing. In this sample, we assume that the final layer of model is just softmax layer, which as most model does, and we only use the <code>cv::minMaxLoc</code> to get the biggest score and position.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> out<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> _size <span class="token operator">=</span> out<span class="token punctuation">.</span>cols <span class="token operator">*</span> out<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>

    <span class="token keyword">double</span> min_val<span class="token punctuation">;</span>
    <span class="token keyword">double</span> max_val<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point min_pos<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point max_pos<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> label <span class="token operator">=</span> max_pos<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">&quot;result: &quot;</span><span class="token operator">&lt;&lt;</span>label<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can do the calculation in the main function.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc<span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Usage: ./cv-dnn-test /path/to/prototxt /path/to/caffemodel /path/to/image.jpg&quot;</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat image <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">init</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">single_inference</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="batch-inference" tabindex="-1"><a class="header-anchor" href="#batch-inference" aria-hidden="true">#</a> Batch Inference</h2><p>Batch inference swallowed multiple images in one forward pass. So we call <code>blobFromImages</code> to turn multiple images into a blob. Dimension <code>N</code> in <code>NCHW</code> is the image count.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Mat cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>InputArrayOfArrays images<span class="token punctuation">,</span>
                            <span class="token keyword">double</span> scalefactor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                            Size size <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Scalar <span class="token operator">&amp;</span> mean <span class="token operator">=</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> swapRB <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> crop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">int</span> ddepth <span class="token operator">=</span> CV_32F<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Creates 4-dimensional blob from series of images. Optionally resizes and crops images from center, subtract mean values, scales values by scalefactor, swap Blue and Red channels.</p><p>Parameters</p><ul><li><code>images</code> input images (all with 1-, 3- or 4-channels).</li><li><code>size</code> spatial size for output image</li><li><code>mean</code> scalar with mean values which are subtracted from channels. Values are intended to be in (mean-R, mean-G, mean-B) order if image has BGR ordering and swapRB is true.</li><li><code>scalefactor</code> multiplier for images values.</li><li><code>swapRB</code> flag which indicates that swap first and last channels in 3-channel image is necessary.</li><li><code>crop</code> flag which indicates whether image will be cropped after resize or not</li><li><code>ddepth</code> Depth of output blob. Choose CV_32F or CV_8U.</li></ul><p>if crop is true, input image is resized so one side after resize is equal to corresponding dimension in size and another one is equal or larger. Then, crop from the center is performed. If crop is false, direct resize without cropping and preserving aspect ratio is performed</p></blockquote><p>The output need to be decomposed. In this model, every single image output is a 1-d softmax results. After Batch Inference, we got N times 1-d softmax arrays, which is a 2-d cv::Mat. Every line represents a single image softmax results. We use the <code>rowRange</code> method to cut the cv::Mat result.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">batch_inference</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span><span class="token operator">&amp;</span> images<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>Mat blob <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> out<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat out_single <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">rowRange</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">post_process</span><span class="token punctuation">(</span>out_single<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="overall-demo" tabindex="-1"><a class="header-anchor" href="#overall-demo" aria-hidden="true">#</a> Overall Demo</h2>`,16),k={href:"https://github.com/cvjena/cnn-models/releases/download/v1.0/cnn-models_cvgj.zip",target:"_blank",rel:"noopener noreferrer"},m=a(`<div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/dnn.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/highgui.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/imgproc.hpp&quot;</span></span>

<span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> Result<span class="token punctuation">;</span>

Result <span class="token function">post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> out<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point min_loc<span class="token punctuation">,</span> max_loc<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_loc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> max_val <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> max_loc<span class="token punctuation">.</span>x <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>max_loc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> max_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> <span class="token function">batch_post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> outs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outs<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> outs<span class="token punctuation">.</span><span class="token function">rowRange</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token function">post_process</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>Net net <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span><span class="token string">&quot;models/deploy.prototxt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;models/resnet50_cvgj_iter_320000.caffemodel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> image_files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;data/a.jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data/b.jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data/c.jpeg&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span> images<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> image_files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat img <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>image_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        images<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat blobs <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat outs <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>outs<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> outs<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> results <span class="token operator">=</span> <span class="token function">batch_post_process</span><span class="token punctuation">(</span>outs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> result_text<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>result_text<span class="token punctuation">,</span> <span class="token string">&quot;%d %.2f&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>first<span class="token punctuation">,</span> result<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">putText</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> result_text<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> window_name<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>window_name<span class="token punctuation">,</span> <span class="token string">&quot;image %d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span>window_name<span class="token punctuation">,</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1);function v(b,h){const t=p("ExternalLinkIcon");return c(),l("div",null,[u,s("p",null,[n("Note that, we open the cuda support for faster inference. If you want to add CUDA support too, please refer to "),s("a",r,[n("Build OpenCV 4.5.2 with CUDA support"),e(t)]),n(".")]),d,s("p",null,[n("We demostrate a full implementation code here to illustrate what we discussed in the previous text. We get the caffe model of ImageNet from ()["),s("a",k,[n("https://github.com/cvjena/cnn-models/releases/download/v1.0/cnn-models_cvgj.zip"),e(t)]),n("].")]),m])}const w=o(i,[["render",v],["__file","2021-08-23-OpenCV-DNN-Batch-Inference.html.vue"]]);export{w as default};
