<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.66" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://bigbookplus.github.io/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html"><meta property="og:site_name" content="Learning BigBook"><meta property="og:title" content="OpenCV DNN Batch Inference in C++"><meta property="og:description" content="OpenCV has a DNN module, which is powerful, efficient, and easy to use. To implement a DNN inference application, we need only to call a couple of APIs which are offered by Open..."><meta property="og:type" content="article"><meta property="og:locale" content="en-US"><meta property="og:updated_time" content="2023-07-18T15:49:04.000Z"><meta property="article:author" content="BigBook"><meta property="article:tag" content="C/C++"><meta property="article:tag" content="OpenCV"><meta property="article:tag" content="Image Classification"><meta property="article:tag" content="Batch Inference"><meta property="article:tag" content="OpenCV DNN"><meta property="article:modified_time" content="2023-07-18T15:49:04.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"OpenCV DNN Batch Inference in C++","image":[""],"dateModified":"2023-07-18T15:49:04.000Z","author":[{"@type":"Person","name":"BigBook"}]}</script><title>OpenCV DNN Batch Inference in C++ | Learning BigBook</title><meta name="description" content="OpenCV has a DNN module, which is powerful, efficient, and easy to use. To implement a DNN inference application, we need only to call a couple of APIs which are offered by Open...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-40599a62.css" as="style"><link rel="stylesheet" href="/assets/style-40599a62.css">
    <link rel="modulepreload" href="/assets/app-d4e9035c.js"><link rel="modulepreload" href="/assets/2021-08-23-OpenCV-DNN-Batch-Inference.html-15ef32fd.js"><link rel="modulepreload" href="/assets/2021-08-23-OpenCV-DNN-Batch-Inference.html-fc7964ce.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-6cec460a.js" as="script"><link rel="prefetch" href="/assets/slides.html-43f4b188.js" as="script"><link rel="prefetch" href="/assets/2012-05-10-fftw-3.3.2-vs2010.html-94d38338.js" as="script"><link rel="prefetch" href="/assets/2021-08-16-opencv-cmake-vs2019.html-5059bab4.js" as="script"><link rel="prefetch" href="/assets/2021-08-18-qthttpserver-qapplication.html-7197dd3f.js" as="script"><link rel="prefetch" href="/assets/2021-08-20-cmake-manage-project.html-99a32cc2.js" as="script"><link rel="prefetch" href="/assets/2021-08-21-qthttpserver-sample.html-7c6a0261.js" as="script"><link rel="prefetch" href="/assets/2021-08-24-minst-rot-how-to.html-cae8f669.js" as="script"><link rel="prefetch" href="/assets/2021-08-24-pytorch-lr_scheduler.html-fccb6625.js" as="script"><link rel="prefetch" href="/assets/2021-08-26-operator-and-in-opencv.html-1b370237.js" as="script"><link rel="prefetch" href="/assets/2022-02-08-install-configure-gitlab-ce.html-5e88cf86.js" as="script"><link rel="prefetch" href="/assets/2022-03-04-MMOCR-Installation-Training-with-own-Data.html-03fe8674.js" as="script"><link rel="prefetch" href="/assets/2022-03-09-easiest-demo-Displaying-CNN-AI-Image-Processing-Results-by-Qt6-in-Python.html-d9668a1e.js" as="script"><link rel="prefetch" href="/assets/2022-03-26-numpy-to-opencv-mat-tips.html-7f020566.js" as="script"><link rel="prefetch" href="/assets/2022-04-14-curved-text-detection-by-paddleocr.html-faa04667.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-cpp-regex.html-643c1d09.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-cvxtext-opencv45.html-325efb40.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-poco-ftp.html-c8c96021.js" as="script"><link rel="prefetch" href="/assets/2022-07-04-build-ffmpeg-with-cuda-centos8.html-a21dad63.js" as="script"><link rel="prefetch" href="/assets/2022-08-11-gnuplot-installation.html-7bc8214b.js" as="script"><link rel="prefetch" href="/assets/2022-11-03-Use-Docker-for-GPU-and-Web-Camera-Applications.html-57eefeae.js" as="script"><link rel="prefetch" href="/assets/2023-03-31-enable-face-recognition-cuda.html-96b4f17e.js" as="script"><link rel="prefetch" href="/assets/2023-04-08-run-docker-without-sudo.html-4b47a67d.js" as="script"><link rel="prefetch" href="/assets/2023-04-11-openvino-installation.html-cab3f54e.js" as="script"><link rel="prefetch" href="/assets/index.html-9e13947f.js" as="script"><link rel="prefetch" href="/assets/tensorflow-io-fault.html-b5e98ef4.js" as="script"><link rel="prefetch" href="/assets/index.html-9764bc95.js" as="script"><link rel="prefetch" href="/assets/disable.html-90b258f4.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-9b048934.js" as="script"><link rel="prefetch" href="/assets/markdown.html-d6ce5cb8.js" as="script"><link rel="prefetch" href="/assets/page.html-fb833914.js" as="script"><link rel="prefetch" href="/assets/index.html-c8bca626.js" as="script"><link rel="prefetch" href="/assets/index.html-f75c75b4.js" as="script"><link rel="prefetch" href="/assets/slides.html-c5891c22.js" as="script"><link rel="prefetch" href="/assets/index.html-04e87ddf.js" as="script"><link rel="prefetch" href="/assets/ray.html-11be4683.js" as="script"><link rel="prefetch" href="/assets/index.html-e843f126.js" as="script"><link rel="prefetch" href="/assets/baz.html-17584802.js" as="script"><link rel="prefetch" href="/assets/index.html-1b4c1aea.js" as="script"><link rel="prefetch" href="/assets/disable.html-4e6fe2b8.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-9997267c.js" as="script"><link rel="prefetch" href="/assets/markdown.html-76adc037.js" as="script"><link rel="prefetch" href="/assets/page.html-279906c4.js" as="script"><link rel="prefetch" href="/assets/index.html-49401c25.js" as="script"><link rel="prefetch" href="/assets/index.html-39624761.js" as="script"><link rel="prefetch" href="/assets/baz.html-3b1bd3e1.js" as="script"><link rel="prefetch" href="/assets/index.html-6fe11484.js" as="script"><link rel="prefetch" href="/assets/ray.html-577aed4a.js" as="script"><link rel="prefetch" href="/assets/404.html-8f44c330.js" as="script"><link rel="prefetch" href="/assets/index.html-490869f7.js" as="script"><link rel="prefetch" href="/assets/slides.html-18970f2e.js" as="script"><link rel="prefetch" href="/assets/2012-05-10-fftw-3.3.2-vs2010.html-3543bc25.js" as="script"><link rel="prefetch" href="/assets/2021-08-16-opencv-cmake-vs2019.html-bd0c6860.js" as="script"><link rel="prefetch" href="/assets/2021-08-18-qthttpserver-qapplication.html-d9f222a0.js" as="script"><link rel="prefetch" href="/assets/2021-08-20-cmake-manage-project.html-e96e9cf4.js" as="script"><link rel="prefetch" href="/assets/2021-08-21-qthttpserver-sample.html-3b390c24.js" as="script"><link rel="prefetch" href="/assets/2021-08-24-minst-rot-how-to.html-66bb51d6.js" as="script"><link rel="prefetch" href="/assets/2021-08-24-pytorch-lr_scheduler.html-258e3a64.js" as="script"><link rel="prefetch" href="/assets/2021-08-26-operator-and-in-opencv.html-3e8610e8.js" as="script"><link rel="prefetch" href="/assets/2022-02-08-install-configure-gitlab-ce.html-43505ffc.js" as="script"><link rel="prefetch" href="/assets/2022-03-04-MMOCR-Installation-Training-with-own-Data.html-c0dca1d3.js" as="script"><link rel="prefetch" href="/assets/2022-03-09-easiest-demo-Displaying-CNN-AI-Image-Processing-Results-by-Qt6-in-Python.html-08ee42eb.js" as="script"><link rel="prefetch" href="/assets/2022-03-26-numpy-to-opencv-mat-tips.html-5ca9e83a.js" as="script"><link rel="prefetch" href="/assets/2022-04-14-curved-text-detection-by-paddleocr.html-e8a03481.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-cpp-regex.html-eb832e88.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-cvxtext-opencv45.html-7d53fdf4.js" as="script"><link rel="prefetch" href="/assets/2022-06-15-poco-ftp.html-f3d94e3d.js" as="script"><link rel="prefetch" href="/assets/2022-07-04-build-ffmpeg-with-cuda-centos8.html-20ad18ba.js" as="script"><link rel="prefetch" href="/assets/2022-08-11-gnuplot-installation.html-5e91d9c4.js" as="script"><link rel="prefetch" href="/assets/2022-11-03-Use-Docker-for-GPU-and-Web-Camera-Applications.html-d6d69f20.js" as="script"><link rel="prefetch" href="/assets/2023-03-31-enable-face-recognition-cuda.html-ade72deb.js" as="script"><link rel="prefetch" href="/assets/2023-04-08-run-docker-without-sudo.html-bd0cf379.js" as="script"><link rel="prefetch" href="/assets/2023-04-11-openvino-installation.html-65d81b46.js" as="script"><link rel="prefetch" href="/assets/index.html-b9d3cbcb.js" as="script"><link rel="prefetch" href="/assets/tensorflow-io-fault.html-63048a1b.js" as="script"><link rel="prefetch" href="/assets/index.html-e3db7513.js" as="script"><link rel="prefetch" href="/assets/disable.html-08e73dc4.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-0d707830.js" as="script"><link rel="prefetch" href="/assets/markdown.html-991194a0.js" as="script"><link rel="prefetch" href="/assets/page.html-29eb3c98.js" as="script"><link rel="prefetch" href="/assets/index.html-74f05608.js" as="script"><link rel="prefetch" href="/assets/index.html-b9d7be09.js" as="script"><link rel="prefetch" href="/assets/slides.html-712fd7f0.js" as="script"><link rel="prefetch" href="/assets/index.html-48aeca01.js" as="script"><link rel="prefetch" href="/assets/ray.html-dfc33144.js" as="script"><link rel="prefetch" href="/assets/index.html-32b79685.js" as="script"><link rel="prefetch" href="/assets/baz.html-ba6cd2cb.js" as="script"><link rel="prefetch" href="/assets/index.html-6416f24e.js" as="script"><link rel="prefetch" href="/assets/disable.html-b4ac84cd.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-e11273bb.js" as="script"><link rel="prefetch" href="/assets/markdown.html-77f6b32b.js" as="script"><link rel="prefetch" href="/assets/page.html-4a89a8d4.js" as="script"><link rel="prefetch" href="/assets/index.html-690a6b54.js" as="script"><link rel="prefetch" href="/assets/index.html-e1eca1dc.js" as="script"><link rel="prefetch" href="/assets/baz.html-e9d5623e.js" as="script"><link rel="prefetch" href="/assets/index.html-1d947d26.js" as="script"><link rel="prefetch" href="/assets/ray.html-4cb0e102.js" as="script"><link rel="prefetch" href="/assets/404.html-c13f2214.js" as="script"><link rel="prefetch" href="/assets/giscus-765fdce2.js" as="script"><link rel="prefetch" href="/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/assets/index-a7d1ee58.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-24884b8c.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-80f40f8f.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt="Learning BigBook"><!----><span class="vp-site-name hide-in-pad">Learning BigBook</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>Project home<!----></a></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link" href="/demo/"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span>Features demo<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Guide"><span class="title"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>Guide</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Bar</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="vp-link nav-link" href="/guide/bar/baz.html"><span class="font-icon icon fa-fw fa-sm fas fa-circle-info" style=""></span>Baz<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/guide/bar/"><span class="font-icon icon fa-fw fa-sm fas fa-ellipsis" style=""></span>...<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Foo</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a class="vp-link nav-link" href="/guide/foo/ray.html"><span class="font-icon icon fa-fw fa-sm fas fa-circle-info" style=""></span>Ray<!----></a></li><li class="dropdown-subitem"><a class="vp-link nav-link" href="/guide/foo/"><span class="font-icon icon fa-fw fa-sm fas fa-ellipsis" style=""></span>...<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="vp-link nav-link active" href="/blog/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>Blogs<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><div class="nav-item"><div class="dropdown-wrapper i18n-dropdown"><button type="button" class="dropdown-title" aria-label="Select language"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="vp-link nav-link active" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html"><!---->English<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/zh/"><!---->ç®€ä½“ä¸­æ–‡<!----></a></li></ul></button></div></div><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>Project home<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading clickable active"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><a class="vp-link nav-link active vp-sidebar-title" href="/blog/"><!---->Blogs<!----></a><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-07-04-build-ffmpeg-with-cuda-centos8.html"><!---->Build FFMpeg with CUDA on CentOS 8<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-16-opencv-cmake-vs2019.html"><!---->Build OpenCV 4.5.2 with CUDA support | CMake+VS2019+Win10+CUDA<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-06-15-cpp-regex.html"><!---->C++ä¸­æ­£åˆ™è¡¨è¾¾å¼çš„ç”¨æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-20-cmake-manage-project.html"><!---->CMakeç®¡ç†C/C++å·¥ç¨‹çš„ä¸€ç‚¹å¿ƒå¾—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-04-14-curved-text-detection-by-paddleocr.html"><!---->Curved Text Detection by PaddleOCR<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2012-05-10-fftw-3.3.2-vs2010.html"><!---->FFTW3.3.2åœ¨VS2010ä¸‹æ­å»ºæ–¹æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-06-15-poco-ftp.html"><!---->How to Implement FTP Upload by C++ and POCO<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-08-11-gnuplot-installation.html"><!---->Installation of GNUPlot 5.4.3 on Linux with png/jpg export support<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-06-15-cvxtext-opencv45.html"><!---->OpenCV 4.X ä½¿ç”¨CvxTextåœ¨å›¾ç‰‡æ˜¾ç¤ºæ±‰å­—<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html"><!---->OpenCV DNN Batch Inference in C++<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#important-apis"><!---->Important APIs<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#difference-between-cv-mat-image-and-blob"><!---->Difference Between cv::Mat Image and Blob<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#include-stuffs-we-need"><!---->Include stuffs we need<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#single-image-inference"><!---->Single Image Inference<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#batch-inference"><!---->Batch Inference<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/blog/2021-08-23-OpenCV-DNN-Batch-Inference.html#overall-demo"><!---->Overall Demo<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-24-pytorch-lr_scheduler.html"><!---->PyTorchä¸­çš„lr_schedulerçš„ç”¨æ³•<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-21-qthttpserver-sample.html"><!---->QtHttpServer Demo and a POST Client<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-02-08-install-configure-gitlab-ce.html"><!---->Setup GitLab Sevice on Ubuntu 16.04 in Local LAN<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-03-09-easiest-demo-Displaying-CNN-AI-Image-Processing-Results-by-Qt6-in-Python.html"><!---->Simplest Demo for Displaying Image Processing Results using PySide6<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-03-26-numpy-to-opencv-mat-tips.html"><!---->Tips of Migrating Numpy to C++ by OpenCV<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-03-04-MMOCR-Installation-Training-with-own-Data.html"><!---->Using MMOCR: Installation and Training with my own Data<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-24-minst-rot-how-to.html"><!---->Using MNIST-ROT Dataset in PyTorch<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-26-operator-and-in-opencv.html"><!---->ä½¿ç”¨&amp;è¿ç®—ç¬¦åœ¨OpenCVå›¾åƒè£å‰ªæ—¶è¿›è¡Œè¾¹ç•Œæ£€æŸ¥<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2022-11-03-Use-Docker-for-GPU-and-Web-Camera-Applications.html"><!---->ä½¿ç”¨Dockerè¾…åŠ©å›¾åƒè¯†åˆ«ç¨‹åºå¼€å‘ï¼šåœ¨Dockerä¸­è®¿é—®GPUå’Œã€USBç›¸æœºä»¥åŠç½‘ç»œ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2023-04-11-openvino-installation.html"><!---->åœ¨Dockerä¸­å®‰è£…å’Œé…ç½®OpenVino 2022.3<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/tensorflow-io-fault.html"><!---->åœ¨kaggleçš„notebook æ‰§è¡Œ import tensorflow-io æŠ¥é”™ undefined symbol<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2021-08-18-qthttpserver-qapplication.html"><!---->åœ¨åŠ¨æ€é“¾æ¥åº“ä¸­ä»¥éGUIå½¢å¼è°ƒç”¨Qtç»„ä»¶å¹¶æä¾›Cè¯­è¨€å½¢å¼API<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2023-03-31-enable-face-recognition-cuda.html"><!---->å¼€å¯face_recognitionçš„CUDAæ”¯æŒä»¥åŠäººè„¸è¯†åˆ«packageçš„ä¸€ç‚¹è®¨è®º<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/blog/2023-04-08-run-docker-without-sudo.html"><!---->æ— éœ€sudoè¿è¡Œdockerå‘½ä»¤<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading clickable"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><a class="vp-link nav-link vp-sidebar-title" href="/demo/"><!---->Demo<!----></a><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/demo/page.html"><span class="font-icon icon fa-fw fa-sm fas fa-file" style=""></span>Page Config<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/demo/markdown.html"><span class="font-icon icon fa-fw fa-sm fab fa-markdown" style=""></span>Markdown Enhance<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/demo/disable.html"><span class="font-icon icon fa-fw fa-sm fas fa-gears" style=""></span>Disabling layout and features<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/demo/encrypt.html"><span class="font-icon icon fa-fw fa-sm fas fa-lock" style=""></span>Encryption Article<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Docs</span><!----></p><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/guide/"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>Guide<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span><span class="vp-sidebar-title">Bar feature</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span><span class="vp-sidebar-title">Foo feature</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/slides.html"><span class="font-icon icon fa-fw fa-sm fas fa-person-chalkboard" style=""></span>Slide page<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->OpenCV DNN Batch Inference in C++</h1><div class="page-info"><span class="page-author-info" aria-label="AuthorğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">BigBook</span></span><span property="author" content="BigBook"></span></span><!----><span class="page-date-info" aria-label="Writing DateğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-18T15:49:04.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 5 min</span><meta property="timeRequired" content="PT5M"></span><!----><span class="page-tag-info" aria-label="TagğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag6" role>C/C++</span><span class="page-tag-item tag4" role>OpenCV</span><span class="page-tag-item tag4" role>Image Classification</span><span class="page-tag-item tag7" role>Batch Inference</span><span class="page-tag-item tag8" role>OpenCV DNN</span><!--]--><meta property="keywords" content="C/C++,OpenCV,Image Classification,Batch Inference,OpenCV DNN"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<button type="button" class="print-button" title="Print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#important-apis">Important APIs</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#difference-between-cv-mat-image-and-blob">Difference Between cv::Mat Image and Blob</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#include-stuffs-we-need">Include stuffs we need</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#single-image-inference">Single Image Inference</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#batch-inference">Batch Inference</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#overall-demo">Overall Demo</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>OpenCV has a DNN module, which is powerful, efficient, and easy to use. To implement a DNN inference application, we need only to call a couple of APIs which are offered by OpenCV DNN module. The basic routine of implementation a DNN inference code by OpenCV is as below.</p><blockquote><ul><li>Initialization. Creating the cv::dnn::Net object by reading in the network weight. (caffe/onnx...)</li><li>Preprocessing. Determine shape of input data of the network. Reshape the raw input image(s) to match the input data shape. This step always combined some other operatations such as normalization.</li><li>Inference. Call inference method by the created cv::dnn::Net object.</li><li>Postprocessing. Decoding the output data and do further wrangling.</li></ul></blockquote><p>In my opinion, as the network weights are already determined, the most important parts of the deployment are pre&amp;postprocessing. You need to figure out exactly what shape of input data is, and what the normalization method is (mean/std value). In post processing, things may be much more complicated. Some tasks are easy to implement, classification tasks for instance. Some tasks will be much harder to implement, such as object detection/segmentation tasks. You need to do a lot of work to crack the data wrangling problems, and sometimes may need to rewrite some operatations yourself from scratch, just because there is no corresponding method with the original python implementation in C++.</p><p>In this article, I will describe a simple implementation of image classification by OpenCV DNN module, and give a fast tour of batch inference.</p><h2 id="important-apis" tabindex="-1"><a class="header-anchor" href="#important-apis" aria-hidden="true">#</a> Important APIs</h2><p>To load the weights into device and create the DNN Net object, Opencv DNN module provided a readNet method. It supports ONNX/Caffe/TF/OpenVINO...</p><p>In this article, we use Caffe model as the example.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Net cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span>  <span class="token keyword">const</span> String <span class="token operator">&amp;</span> prototxt<span class="token punctuation">,</span> \
                                <span class="token keyword">const</span> String <span class="token operator">&amp;</span> caffeModel <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>This API will read the network weights in Caffe format.</p><p>Parameters</p><ul><li><code>prototxt</code> path to the .prototxt file with text description of the network architecture.</li><li><code>caffeModel</code> path to the .caffemodel file with learned network.</li></ul><p>Returns<br> Net object.</p></blockquote><p>We also need to call <code>blobFromImage</code> to do some preprocessing on the input cv::Mat image.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Mat cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImage</span><span class="token punctuation">(</span> InputArray image<span class="token punctuation">,</span>
                            <span class="token keyword">double</span> scalefactor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Size <span class="token operator">&amp;</span> size <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Scalar <span class="token operator">&amp;</span> mean <span class="token operator">=</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> swapRB <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> crop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">int</span> ddepth <span class="token operator">=</span> CV_32F<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Creates 4-dimensional blob from image. Optionally resizes and crops image from center, subtract mean values, scales values by scalefactor, swap Blue and Red channels.</p><p>Parameters</p><ul><li><code>image</code> input image (with 1-, 3- or 4-channels).</li><li><code>size</code> spatial size for output image</li><li><code>mean</code> scalar with mean values which are subtracted from channels. Values are intended to be in (mean-R, mean-G, mean-B) order if image has BGR ordering and swapRB is true.</li><li><code>scalefactor</code> multiplier for image values.</li><li><code>swapRB</code> flag which indicates that swap first and last channels in 3-channel image is necessary.</li><li><code>crop</code> flag which indicates whether image will be cropped after resize or not</li><li><code>ddepth</code> Depth of output blob. Choose CV_32F or CV_8U.<br> if crop is true, input image is resized so one side after resize is equal to corresponding dimension in size and another one is equal or larger. Then, crop from the center is performed. If crop is false, direct resize without cropping and preserving aspect ratio is performed.</li></ul><p>Returns<br> 4-dimensional Mat with NCHW dimensions order.</p></blockquote><h2 id="difference-between-cv-mat-image-and-blob" tabindex="-1"><a class="header-anchor" href="#difference-between-cv-mat-image-and-blob" aria-hidden="true">#</a> Difference Between cv::Mat Image and Blob</h2><p>The mainly difference is the data format. In normal cv::Mat image, the data is arranged in HWC format, like <code>RGBRGB...RGB</code>. But when turned into blobs, it becomes NCHW format, as most neural networks does.</p><p>In normal cv::Mat image, we get width and height by member <code>cols</code> and <code>rows</code>, but in blob, these two vars is -1. We get blob size by <code>blob.size(0)</code> <code>blob.size(1)</code> etc. This is useful when we need to decompose the result mat from batch inference.</p><h2 id="include-stuffs-we-need" tabindex="-1"><a class="header-anchor" href="#include-stuffs-we-need" aria-hidden="true">#</a> Include stuffs we need</h2><p>We firstly include all the stuffs to use OpenCV DNN. Then we declare a Global cv::dnn:Net Variable. This var will load net weights from your disk and do nearly all the nn calculation tasks.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/dnn.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core/cuda.hpp&quot;</span></span>

<span class="token comment">// Global net variable.</span>
cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>Net net<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Suppose we have a caffe model, we pass the <code>.prototxt</code> file name to the var <code>model_deploy</code>, and <code>.caffemodel</code> file to var <code>model_bin</code>. We do the init works in this <code>init</code> function:</p><p>Note that, we open the cuda support for faster inference. If you want to add CUDA support too, please refer to <a href="http://bigbook.plus/2021/08/16/opencv-cmake-vs2019/" target="_blank" rel="noopener noreferrer">Build OpenCV 4.5.2 with CUDA support<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> model_deploy<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> model_bin<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    net <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span>model_deploy<span class="token punctuation">,</span> model_bin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Let CUDA be the calculation device.</span>
    cv<span class="token double-colon punctuation">::</span>cuda<span class="token double-colon punctuation">::</span><span class="token function">setDevice</span><span class="token punctuation">(</span>cuda_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>net<span class="token punctuation">.</span><span class="token function">setPreferableBackend</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>net<span class="token punctuation">.</span><span class="token function">setPreferableTarget</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>DNN_TARGET_CUDA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="single-image-inference" tabindex="-1"><a class="header-anchor" href="#single-image-inference" aria-hidden="true">#</a> Single Image Inference</h2><p>Now we try to do the single image inference.</p><p>It&#39;s simple. Call <code>blobFromImage</code> method to turn the image into a blob, then set this blob as the input to <code>net</code> by <code>net.setInput</code>, finally we got the output <code>cv::Mat</code> by <code>net.forward()</code>.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">single_inference</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> image<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;empty image!!!&quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat blob <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
    cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">post_process</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>After we got the original output by neural network, we need to do the post-processing. In this sample, we assume that the final layer of model is just softmax layer, which as most model does, and we only use the <code>cv::minMaxLoc</code> to get the biggest score and position.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> out<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> _size <span class="token operator">=</span> out<span class="token punctuation">.</span>cols <span class="token operator">*</span> out<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>

    <span class="token keyword">double</span> min_val<span class="token punctuation">;</span>
    <span class="token keyword">double</span> max_val<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point min_pos<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point max_pos<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> label <span class="token operator">=</span> max_pos<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">&quot;result: &quot;</span><span class="token operator">&lt;&lt;</span>label<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can do the calculation in the main function.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc<span class="token operator">!=</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Usage: ./cv-dnn-test /path/to/prototxt /path/to/caffemodel /path/to/image.jpg&quot;</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat image <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">init</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">single_inference</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="batch-inference" tabindex="-1"><a class="header-anchor" href="#batch-inference" aria-hidden="true">#</a> Batch Inference</h2><p>Batch inference swallowed multiple images in one forward pass. So we call <code>blobFromImages</code> to turn multiple images into a blob. Dimension <code>N</code> in <code>NCHW</code> is the image count.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code>Mat cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>InputArrayOfArrays images<span class="token punctuation">,</span>
                            <span class="token keyword">double</span> scalefactor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                            Size size <span class="token operator">=</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">const</span> Scalar <span class="token operator">&amp;</span> mean <span class="token operator">=</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> swapRB <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">bool</span> crop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token keyword">int</span> ddepth <span class="token operator">=</span> CV_32F<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Creates 4-dimensional blob from series of images. Optionally resizes and crops images from center, subtract mean values, scales values by scalefactor, swap Blue and Red channels.</p><p>Parameters</p><ul><li><code>images</code> input images (all with 1-, 3- or 4-channels).</li><li><code>size</code> spatial size for output image</li><li><code>mean</code> scalar with mean values which are subtracted from channels. Values are intended to be in (mean-R, mean-G, mean-B) order if image has BGR ordering and swapRB is true.</li><li><code>scalefactor</code> multiplier for images values.</li><li><code>swapRB</code> flag which indicates that swap first and last channels in 3-channel image is necessary.</li><li><code>crop</code> flag which indicates whether image will be cropped after resize or not</li><li><code>ddepth</code> Depth of output blob. Choose CV_32F or CV_8U.</li></ul><p>if crop is true, input image is resized so one side after resize is equal to corresponding dimension in size and another one is equal or larger. Then, crop from the center is performed. If crop is false, direct resize without cropping and preserving aspect ratio is performed</p></blockquote><p>The output need to be decomposed. In this model, every single image output is a 1-d softmax results. After Batch Inference, we got N times 1-d softmax arrays, which is a 2-d cv::Mat. Every line represents a single image softmax results. We use the <code>rowRange</code> method to cut the cv::Mat result.</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">batch_inference</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span><span class="token operator">&amp;</span> images<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>Mat blob <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> out<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat out_single <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">rowRange</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">post_process</span><span class="token punctuation">(</span>out_single<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="overall-demo" tabindex="-1"><a class="header-anchor" href="#overall-demo" aria-hidden="true">#</a> Overall Demo</h2><p>We demostrate a full implementation code here to illustrate what we discussed in the previous text. We get the caffe model of ImageNet from ()[<a href="https://github.com/cvjena/cnn-models/releases/download/v1.0/cnn-models_cvgj.zip" target="_blank" rel="noopener noreferrer">https://github.com/cvjena/cnn-models/releases/download/v1.0/cnn-models_cvgj.zip<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>].</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/core.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/dnn.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/highgui.hpp&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;opencv2/imgproc.hpp&quot;</span></span>

<span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> Result<span class="token punctuation">;</span>

Result <span class="token function">post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> out<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point min_loc<span class="token punctuation">,</span> max_loc<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_val<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_loc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> max_val <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> max_loc<span class="token punctuation">.</span>x <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>max_loc<span class="token punctuation">.</span>x<span class="token punctuation">,</span> max_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> <span class="token function">batch_post_process</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> outs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outs<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat out <span class="token operator">=</span> outs<span class="token punctuation">.</span><span class="token function">rowRange</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token function">post_process</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span>Net net <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">readNetFromCaffe</span><span class="token punctuation">(</span><span class="token string">&quot;models/deploy.prototxt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;models/resnet50_cvgj_iter_320000.caffemodel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> image_files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;data/a.jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data/b.jpeg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data/c.jpeg&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&gt;</span> images<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> image_files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        cv<span class="token double-colon punctuation">::</span>Mat img <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span>image_files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        images<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token double-colon punctuation">::</span>Mat blobs <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span>dnn<span class="token double-colon punctuation">::</span><span class="token function">blobFromImages</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat outs <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>outs<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> outs<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> results <span class="token operator">=</span> <span class="token function">batch_post_process</span><span class="token punctuation">(</span>outs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> result_text<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>result_text<span class="token punctuation">,</span> <span class="token string">&quot;%d %.2f&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>first<span class="token punctuation">,</span> result<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">putText</span><span class="token punctuation">(</span>images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> result_text<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> window_name<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>window_name<span class="token punctuation">,</span> <span class="token string">&quot;image %d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span>window_name<span class="token punctuation">,</span> images<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">Last update: </span><!----></div><div class="contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: xuling.chang@live.com">Xuling Chang</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/blog/2022-06-15-cvxtext-opencv45.html"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->OpenCV 4.X ä½¿ç”¨CvxTextåœ¨å›¾ç‰‡æ˜¾ç¤ºæ±‰å­—</div></a><a class="vp-link nav-link next" href="/blog/2021-08-24-pytorch-lr_scheduler.html"><div class="hint">Next<span class="arrow end"></span></div><div class="link">PyTorchä¸­çš„lr_schedulerçš„ç”¨æ³•<!----></div></a></nav><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Learning BigBook</div><div class="vp-copyright">Copyright Â© 2023 BigBook</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-d4e9035c.js" defer></script>
  </body>
</html>
